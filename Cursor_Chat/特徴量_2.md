# LightGBMの特徴量についての質問
_Exported on 2025/9/17 at 17:05:59 JST from Cursor (1.5.9)_

---

**User**

layer4でLightGBMの学習に使ってる特徴量について教えて
ただし，中で展開されてるディレクトリablation/などについては関係ないです．

---

**Cursor**

layer4でLightGBMの学習に使われている特徴量について調べてみますね。まず、layer4ディレクトリ内の主要なファイルを確認して、特徴量の定義や使用方法を把握します。


次に、特徴量選択の仕組みを理解するために、`common.feature_gate`モジュールを確認します。


さらに、実際に使用されている特徴量の詳細を確認するために、特徴量エンジニアリングの部分も見てみましょう。


layer4でLightGBMの学習に使われている特徴量について詳しく説明いたします。

## layer4のLightGBM学習で使用されている特徴量

### 1. 基本特徴量（53個の特徴量）

`feature_list.json`で定義されている53個の特徴量は以下のカテゴリに分類されます：

#### **時代・期間フラグ特徴量（5個）**
- `era_covid`: コロナ期間フラグ
- `era_post2009`: 2009年以降フラグ  
- `era_post2013`: 2013年以降フラグ
- `era_post2022`: 2022年以降フラグ
- `era_pre2013`: 2013年以前フラグ

#### **外国人関連特徴量（20個）**
- **基本統計**: `foreign_population`, `foreign_log`, `foreign_ma3`
- **変化量**: `foreign_change`, `foreign_pct_change`
- **期間別変数**: 各基本統計に`_covid`, `_post2022`のサフィックスが付いたもの
- **変化率**: `foreign_change_rate`, `foreign_change_rate_2022_2023`

#### **時系列特徴量（3個）**
- `lag_d1`: 1年ラグ
- `lag_d2`: 2年ラグ  
- `ma2_delta`: 2年移動平均差分

#### **マクロ経済特徴量（4個）**
- `macro_delta`: マクロ経済変化量
- `macro_excl`: マクロ経済除外フラグ
- `macro_ma3`: マクロ経済3年移動平均
- `macro_shock`: マクロ経済ショック

#### **人口・地域特徴量（3個）**
- `pop_total`: 総人口
- `town_ma5`: 町丁5年移動平均
- `town_std5`: 町丁5年標準偏差
- `town_trend5`: 町丁5年トレンド

#### **空間ラグ特徴量（18個）**
- `ring1_exp_*`: 第1リング（隣接地域）の期待効果
  - 商業収入（`commercial_inc`）
  - 災害減少（`disaster_dec`）
  - 災害増加（`disaster_inc`）
  - 雇用増加（`employment_inc`）
  - 住宅減少（`housing_dec`）
  - 住宅増加（`housing_inc`）
  - 公共教育医療減少（`public_edu_medical_dec`）
  - 各特徴量に`_h1`, `_h2`, `_h3`のサフィックス（異なる期間）

### 2. 動的に追加される特徴量

`add_enhanced_features`関数で追加される特徴量：

#### **年次トレンド特徴量（5個）**
- `year_normalized`: 正規化された年
- `year_squared`: 年の2乗
- `year_cubic`: 年の3乗
- `year_sin_10`: 10年周期のサイン
- `year_cos_10`: 10年周期のコサイン

#### **期間別フラグ特徴量（4個）**
- `is_anomaly_period`: 異常値期間（2022-2023年）
- `is_covid_period`: コロナ期間（2020-2021年）
- `is_post_covid`: ポストコロナ期間（2022年以降）
- `is_2022_2023`: 2022-2023年特化フラグ

#### **人口規模変換特徴量（4個）**
- `pop_total_log`: 人口の対数変換
- `pop_total_sqrt`: 人口の平方根変換
- `pop_total_squared`: 人口の2乗
- `years_since_2020`: 2020年からの経過年数

#### **その他の特徴量（2個）**
- `covid_impact_factor`: コロナ影響係数
- `foreign_change_rate`: 外国人変化率（動的計算）

### 3. 特徴量選択の仕組み

`common.feature_gate`モジュールにより：

#### **除外される特徴量**
- `exp_*`: 期待効果関連（直接効果のみ除外）
- `manual_people_*`: 手動人数データ
- `ring1_manual_people_*`, `ring2_manual_people_*`: 空間ラグの手動人数

#### **含まれる特徴量**
- 基本的な数値特徴量
- `ring1_*`, `ring2_*`のうち`manual_people_`以外
- 特定のパターンにマッチする特徴量

### 4. 特徴量の用途

- **目的変数**: `delta_people`（人口変化量）
- **時系列CV**: expanding window（20年以上の学習データ）
- **サンプル重み**: 人口規模×時間減衰×異常値期間調整
- **外れ値処理**: ウィンズライズ（上下0.5%）

この特徴量セットは、人口変化の予測に必要な時系列、空間、経済、社会要因を包括的にカバーしており、特に2022-2023年の異常値期間やコロナ影響を考慮した設計になっています。

---

**User**

マクロ経済特徴ってどうやって算出してるの？

---

**Cursor**

マクロ経済特徴量の算出方法について調べてみますね。まず、layer4の特徴量生成に関連するファイルを確認します。


マクロ経済特徴量の算出方法が分かりました！`build_expected_effects.py`ファイルで詳細を確認してみましょう。


さらに詳しく、マクロ経済特徴量の算出部分を確認しましょう。


マクロ経済特徴量の算出方法について詳しく説明いたします。

## マクロ経済特徴量の算出方法

layer4で使用されている4つのマクロ経済特徴量は、以下のように算出されています：

### 1. **macro_delta**（マクロ経済変化量）
```python
# 年ごとの全町丁の人口変化量の合計
yr = out.groupby("year")["delta_people"].sum().reset_index().rename(columns={"delta_people":"macro_delta"})
```
- **定義**: 各年の全町丁の人口変化量（`delta_people`）の合計
- **意味**: その年の全国的な人口変化の総量
- **用途**: マクロ経済全体の動向を表す指標

### 2. **macro_ma3**（マクロ経済3年移動平均）
```python
yr["macro_ma3"] = yr["macro_delta"].rolling(3, min_periods=1).mean()
```
- **定義**: `macro_delta`の3年移動平均
- **意味**: マクロ経済変化のトレンド（短期変動を平滑化）
- **用途**: 長期的な人口変化の傾向を捉える

### 3. **macro_shock**（マクロ経済ショック）
```python
yr["macro_shock"] = yr["macro_delta"] - yr["macro_ma3"]  # その年だけの異常分
```
- **定義**: `macro_delta`から`macro_ma3`を引いた値
- **意味**: その年の異常な人口変化（トレンドからの乖離）
- **用途**: 経済ショックや特殊要因による人口変化を捉える

### 4. **macro_excl**（マクロ経済除外）
```python
out["macro_excl"] = out["macro_delta"] - out["delta_people"].fillna(0.0)
```
- **定義**: `macro_delta`から各町丁の`delta_people`を引いた値
- **意味**: その町丁を除いた全国の人口変化量
- **用途**: その町丁に影響を与える外部要因を表す

### 特徴量の特徴

1. **年次集計ベース**: 全ての特徴量が年ごとに集計された値を使用
2. **先読み防止**: 町丁レベルの特徴量は`shift(1)`で1期先読みを防止
3. **マクロ視点**: 個別町丁の特性ではなく、全国的な動向を捉える
4. **時系列構造**: 移動平均やショック検出により時系列の構造を活用

### 使用目的

これらのマクロ経済特徴量は、個別町丁の人口変化に影響を与える**外部要因**を捉えるために使用されています：

- **経済環境**: 全国的な経済状況の変化
- **政策効果**: 国レベルの政策による影響
- **社会情勢**: コロナ等の社会情勢の変化
- **地域間相互作用**: 他地域の変化が当該地域に与える影響

この設計により、個別町丁の特性（`town_*`特徴量）と全国的な動向（`macro_*`特徴量）を組み合わせて、より精度の高い人口変化予測を実現しています。

```python
# 年ごとの全町丁の人口変化量の合計
yr = out.groupby("year")["delta_people"].sum().reset_index().rename(columns={"delta_people":"macro_delta"})
```

```python
yr["macro_ma3"] = yr["macro_delta"].rolling(3, min_periods=1).mean()
```

```python
yr["macro_shock"] = yr["macro_delta"] - yr["macro_ma3"]  # その年だけの異常分
```

```python
out["macro_excl"] = out["macro_delta"] - out["delta_people"].fillna(0.0)
```

---

**User**

いやだからそのmacro_deltaとかはどこから出てきたの？

---

**Cursor**

`macro_delta`などのマクロ経済特徴量がどこから来ているのか、データの流れを追って確認してみますね。


データの流れを確認するために、入力ファイルの構造を見てみましょう。


データの流れが分かりました！`macro_delta`の出所を説明いたします。

## `macro_delta`の出所とデータの流れ

### 1. **元データの出所**
`macro_delta`は以下の流れで生成されています：

1. **`features_panel.csv`** ← 元の人口データ（`pop_total`列）
2. **`build_expected_effects.py`** ← ここで`delta_people`を計算
3. **`macro_delta`** ← `delta_people`の年次合計

### 2. **具体的な計算過程**

```python
# 1. 元データから人口変化量を計算
if "delta_people" not in out.columns and "pop_total" in out.columns:
    out["delta_people"] = out.groupby("town")["pop_total"].diff()

# 2. 年ごとの全町丁の人口変化量を合計
yr = out.groupby("year")["delta_people"].sum().reset_index().rename(columns={"delta_people":"macro_delta"})
```

### 3. **データの意味**

- **`pop_total`**: 各町丁の総人口（元データ）
- **`delta_people`**: 各町丁の前年比人口変化量（`pop_total.diff()`）
- **`macro_delta`**: その年の全町丁の人口変化量の合計

### 4. **具体例**

例えば、2020年の場合：
- 町丁A: `delta_people = +50人`
- 町丁B: `delta_people = -30人`  
- 町丁C: `delta_people = +20人`
- **`macro_delta` = 50 + (-30) + 20 = +40人**

### 5. **他のマクロ特徴量との関係**

```python
# macro_deltaから派生する特徴量
yr["macro_ma3"] = yr["macro_delta"].rolling(3, min_periods=1).mean()  # 3年移動平均
yr["macro_shock"] = yr["macro_delta"] - yr["macro_ma3"]  # トレンドからの乖離
out["macro_excl"] = out["macro_delta"] - out["delta_people"]  # 当該町丁を除いた合計
```

つまり、**`macro_delta`は元々の人口データ（`pop_total`）から計算された人口変化量の年次合計**であり、外部のマクロ経済データではなく、**内部の人口データから生成された特徴量**です。

この特徴量は、個別町丁の人口変化に影響を与える**全国的な人口動向**を捉えるために使用されています。

```python
# 1. 元データから人口変化量を計算
if "delta_people" not in out.columns and "pop_total" in out.columns:
    out["delta_people"] = out.groupby("town")["pop_total"].diff()

# 2. 年ごとの全町丁の人口変化量を合計
yr = out.groupby("year")["delta_people"].sum().reset_index().rename(columns={"delta_people":"macro_delta"})
```

```python
# macro_deltaから派生する特徴量
yr["macro_ma3"] = yr["macro_delta"].rolling(3, min_periods=1).mean()  # 3年移動平均
yr["macro_shock"] = yr["macro_delta"] - yr["macro_ma3"]  # トレンドからの乖離
out["macro_excl"] = out["macro_delta"] - out["delta_people"]  # 当該町丁を除いた合計
```

