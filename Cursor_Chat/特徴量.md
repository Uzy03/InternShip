# LightGBMの特徴量についての質問
_Exported on 2025/9/17 at 15:43:06 JST from Cursor (1.5.9)_

---

**User**

layer4でLightGBMの学習に使ってる特徴量について教えて
ただし，中で展開されてるディレクトリablation/などについては関係ないです．

---

**Cursor**

layer4でLightGBMの学習に使われている特徴量について調べてみますね。まず、layer4ディレクトリ内の主要なファイルを確認して、特徴量の定義や使用方法を把握します。


次に、特徴量選択の仕組みを理解するために、`common.feature_gate`モジュールを確認します。


さらに、実際に使用されている特徴量の詳細を確認するために、特徴量エンジニアリングの部分も見てみましょう。


layer4でLightGBMの学習に使われている特徴量について詳しく説明いたします。

## layer4のLightGBM学習で使用されている特徴量

### 1. 基本特徴量（53個の特徴量）

`feature_list.json`で定義されている53個の特徴量は以下のカテゴリに分類されます：

#### **時代・期間フラグ特徴量（5個）**
- `era_covid`: コロナ期間フラグ
- `era_post2009`: 2009年以降フラグ  
- `era_post2013`: 2013年以降フラグ
- `era_post2022`: 2022年以降フラグ
- `era_pre2013`: 2013年以前フラグ

#### **外国人関連特徴量（20個）**
- **基本統計**: `foreign_population`, `foreign_log`, `foreign_ma3`
- **変化量**: `foreign_change`, `foreign_pct_change`
- **期間別変数**: 各基本統計に`_covid`, `_post2022`のサフィックスが付いたもの
- **変化率**: `foreign_change_rate`, `foreign_change_rate_2022_2023`

#### **時系列特徴量（3個）**
- `lag_d1`: 1年ラグ
- `lag_d2`: 2年ラグ  
- `ma2_delta`: 2年移動平均差分

#### **マクロ経済特徴量（4個）**
- `macro_delta`: マクロ経済変化量
- `macro_excl`: マクロ経済除外フラグ
- `macro_ma3`: マクロ経済3年移動平均
- `macro_shock`: マクロ経済ショック

#### **人口・地域特徴量（3個）**
- `pop_total`: 総人口
- `town_ma5`: 町丁5年移動平均
- `town_std5`: 町丁5年標準偏差
- `town_trend5`: 町丁5年トレンド

#### **空間ラグ特徴量（18個）**
- `ring1_exp_*`: 第1リング（隣接地域）の期待効果
  - 商業収入（`commercial_inc`）
  - 災害減少（`disaster_dec`）
  - 災害増加（`disaster_inc`）
  - 雇用増加（`employment_inc`）
  - 住宅減少（`housing_dec`）
  - 住宅増加（`housing_inc`）
  - 公共教育医療減少（`public_edu_medical_dec`）
  - 各特徴量に`_h1`, `_h2`, `_h3`のサフィックス（異なる期間）

### 2. 動的に追加される特徴量

`add_enhanced_features`関数で追加される特徴量：

#### **年次トレンド特徴量（5個）**
- `year_normalized`: 正規化された年
- `year_squared`: 年の2乗
- `year_cubic`: 年の3乗
- `year_sin_10`: 10年周期のサイン
- `year_cos_10`: 10年周期のコサイン

#### **期間別フラグ特徴量（4個）**
- `is_anomaly_period`: 異常値期間（2022-2023年）
- `is_covid_period`: コロナ期間（2020-2021年）
- `is_post_covid`: ポストコロナ期間（2022年以降）
- `is_2022_2023`: 2022-2023年特化フラグ

#### **人口規模変換特徴量（4個）**
- `pop_total_log`: 人口の対数変換
- `pop_total_sqrt`: 人口の平方根変換
- `pop_total_squared`: 人口の2乗
- `years_since_2020`: 2020年からの経過年数

#### **その他の特徴量（2個）**
- `covid_impact_factor`: コロナ影響係数
- `foreign_change_rate`: 外国人変化率（動的計算）

### 3. 特徴量選択の仕組み

`common.feature_gate`モジュールにより：

#### **除外される特徴量**
- `exp_*`: 期待効果関連（直接効果のみ除外）
- `manual_people_*`: 手動人数データ
- `ring1_manual_people_*`, `ring2_manual_people_*`: 空間ラグの手動人数

#### **含まれる特徴量**
- 基本的な数値特徴量
- `ring1_*`, `ring2_*`のうち`manual_people_`以外
- 特定のパターンにマッチする特徴量

### 4. 特徴量の用途

- **目的変数**: `delta_people`（人口変化量）
- **時系列CV**: expanding window（20年以上の学習データ）
- **サンプル重み**: 人口規模×時間減衰×異常値期間調整
- **外れ値処理**: ウィンズライズ（上下0.5%）

この特徴量セットは、人口変化の予測に必要な時系列、空間、経済、社会要因を包括的にカバーしており、特に2022-2023年の異常値期間やコロナ影響を考慮した設計になっています。

