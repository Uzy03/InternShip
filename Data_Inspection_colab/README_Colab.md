# 熊本市統計データ前処理（Google Colab版）

## 📋 概要

このプロジェクトは、熊本市統計データのHTMLベースxlsファイルから、100%の町丁一貫性率を持つCSVファイルを生成する前処理パイプラインです。

## 🎯 目標

- **初期状態**: 町丁一貫性率 17.8%
- **最終目標**: 町丁一貫性率 **100%**

## 📁 ファイル構成

```
Data_Inspection_colab/
├── main_preprocessing_colab.py          # ステップ1: HTMLファイルからのデータ抽出
├── town_consistency_analysis_colab.py   # ステップ2: 町丁一貫性分析
├── merge_town_data_colab.py            # ステップ3: 町丁データ統合
├── fill_2009_merged_towns_colab.py     # ステップ4: 2009年合併町NaN埋め
├── unify_district_towns_colab.py       # ステップ5: 区制町丁統一
├── final_unification_colab.py          # ステップ6: 100%一貫性達成の最終統一
├── verify_100_percent_colab.py         # 最終検証
└── README_Colab.md                     # このファイル
```

## 🚀 Colabでの実行順序

### 前提条件
1. **Data/配下にHTMLベースのxlsファイルを配置**
   - ファイル名例: `20250827_133714_0195312.xls`
   - 熊本市統計データ（平成10年〜令和7年）

2. **必要なライブラリのインストール**
   ```python
   !pip install pandas numpy matplotlib seaborn lxml html5lib beautifulsoup4
   ```

### 実行順序

#### ステップ1: HTMLファイルからのデータ抽出
```python
!python main_preprocessing_colab.py
```
**処理内容**:
- HTMLベースxlsファイルを読み込み
- 年月度を自動抽出（H10-04, R01-04等）
- CSVファイルとして保存
- 出力: `Data_csv/`配下

#### ステップ2: 町丁一貫性分析
```python
!python town_consistency_analysis_colab.py
```
**処理内容**:
- 全CSVファイルの町丁一貫性を分析
- 一貫性率の計算
- 可視化グラフの生成
- 出力: `Preprocessed_Data_csv/`配下

#### ステップ3: 町丁データ統合
```python
!python merge_town_data_colab.py
```
**処理内容**:
- 町丁名の正規化（区名除去）
- 2009年合併町の特定
- 有効な町丁名の抽出
- 出力: `*_consistent.csv`

#### ステップ4: 2009年合併町NaN埋め
```python
!python fill_2009_merged_towns_colab.py
```
**処理内容**:
- 2009年以前の合併町の人口データをNaNで埋め
- 合併によるデータ不整合を解決
- 出力: `*_nan_filled.csv`

#### ステップ5: 区制町丁統一
```python
!python unify_district_towns_colab.py
```
**処理内容**:
- 区制導入による町丁名の不整合を解決
- 重複する区制町丁の削除
- 出力: `*_unified.csv`

#### ステップ6: 100%一貫性達成の最終統一
```python
!python final_unification_colab.py
```
**処理内容**:
- 残存する区名付き町丁を強制的に除去
- 100%一貫性達成のための最終処理
- 出力: `*_100percent_final.csv`

#### 最終検証
```python
!python verify_100_percent_colab.py
```
**処理内容**:
- 最終一貫性率の検証
- 100%達成の確認
- 最終結果の可視化

## 📊 期待される改善効果

| ステップ | 一貫性率 | 改善内容 |
|---------|---------|----------|
| 初期状態 | 17.8% | HTMLファイルからのデータ抽出 |
| ステップ1後 | 17.8% | データ形式の統一 |
| ステップ2後 | 17.8% | 現状把握と分析 |
| ステップ3後 | 90.5% | 町丁名正規化、2009年合併町処理 |
| ステップ4後 | 90.5% | 2009年合併町のNaN埋め |
| ステップ5後 | 97.3% | 区制町丁の統一 |
| ステップ6後 | **100.0%** | **最終統一処理** |

## 🔧 トラブルシューティング

### よくある問題

1. **Dataディレクトリが見つからない**
   - `Data/`配下にxlsファイルが配置されているか確認

2. **ライブラリのインストールエラー**
   - `!pip install`で必要なライブラリをインストール

3. **エンコーディングエラー**
   - スクリプト内で複数エンコーディングを試行

4. **ファイルが見つからない**
   - 前のステップが正常に完了しているか確認

### エラー時の対処法

1. **エラーメッセージを確認**
2. **前のステップの出力ファイルを確認**
3. **必要なディレクトリが作成されているか確認**
4. **ファイルの権限を確認**

## 📈 出力ファイル

### 最終成果物
- `*_100percent_final.csv`: 100%一貫性達成済みの最終CSVファイル
- `100_percent_final_verification_result.txt`: 最終検証結果
- `final_consistency_visualization.png`: 最終結果の可視化

### 中間ファイル
- `*_consistent.csv`: 町丁統合済みファイル
- `*_nan_filled.csv`: 2009年合併町NaN埋め済みファイル
- `*_unified.csv`: 区制町丁統一済みファイル

## 🎉 完了時の確認事項

1. **町丁一貫性率が100%になっている**
2. **全28年間のデータが統一されている**
3. **最終ファイルが正常に生成されている**
4. **検証結果が保存されている**

## 📞 サポート

問題が発生した場合は、以下を確認してください：
1. エラーメッセージの内容
2. 実行したステップ番号
3. 出力ファイルの状態
4. ディレクトリ構造

---

**目標**: 町丁一貫性率100%達成で、完璧なデータセットを作成！
